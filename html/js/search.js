var UserSearch=function(textfield,container,action){var search=this;search._textfield=$('#'+textfield);search._container=$('#'+container);search._action=action;try{document.createEvent('TouchEvent');search.isMobile=true;}catch(e){search.isMobile=false;}
search._textfield.on('keypress',function(e){if(e.keyCode==13){$(this).trigger('enter');e.preventDefault();}else if($(this).hasClass('search-input-error')){$(this).prop('class','search-input-normal');}}).on('enter',function(){search.start();});if(search.isMobile){search._container.removeClass().parent().addClass('mobile-view');}};UserSearch.prototype.setSearchDefaults=function(){this._textfield.prop('disabled',false).val('').focus();this._container.empty();};UserSearch.prototype.start=function(){var search=this;search._textfield.val(search._textfield.val().replace(/\\|\//g,''));if(!search._textfield.val().length){return false;}
var cache,diff;if(typeof localStorage!='undefined'&&(cache=localStorage.getItem(search._textfield.val()))){cache=JSON.parse(cache);diff=(new Date().getTime()-cache.timestamp)/60000;if(diff>15){localStorage.removeItem(search._textfield.val());}else{return this.showResultTab(cache.data);}}
search._textfield.prop('disabled','disabled');search._container.empty().html('<img src="'+location.origin+'/images/ajax.gif" />');$.post(location.origin+search._action,{'query':search._textfield.val()}).done(function(response){if(response){response=JSON.parse(response).data;if(typeof localStorage!='undefined'&&!localStorage.getItem(search._textfield.val())){try{localStorage.setItem(search._textfield.val(),JSON.stringify({'timestamp':new Date().getTime(),'data':response}));}catch(e){console.log('error: '+e.message);}}
search.showResultTab(response);}}).fail(function(){search._container.html('<p>Something wrong! Maybe incorrect search string?</p>');}).always(function(){search._textfield.prop('disabled',false).blur();});};UserSearch.prototype.showResultTab=function(response){var data='';var count=0;var tmp,key,i,hdr,icon,hcat;var html='<table id="search-result-tab">'+'<caption>'+'<i class="uk-icon-search"></i> Searching results (<span></span>):'+'</caption>'+'<thead>'+'<tr>';var headers=['Users','uk-icon-user','Categories','uk-icon-list-alt','Brands','uk-icon-briefcase','Products','uk-icon-shopping-cart'];for(key in response){icon=headers.pop();hcat=headers.pop();if(response[key].length){tmp='<td class="wb"><ul>';for(i=0;i<response[key].length;i++){if(hcat=='Brands'){var link=$('<div/>').text(response[key][i]['link']).html();}else{var link=$('<div/>').text(response[key][i]['link']).html();}
var text=$('<div/>').text(response[key][i]['name']).html();text=text.toLowerCase().indexOf(this._textfield.val().toLowerCase())!=-1&&this._textfield.val().length>1?text.replace(new RegExp('('+this._textfield.val()+')','i'),'<span>$1</span>'):text;tmp+='<li>'+'<a href="'+link.toLowerCase()+'">'+'<i class="uk-icon-chevron-right"></i> '+text+'</a>'+'</li>';count++;window.location.href=link.toLowerCase();}
tmp+='</ul></td>';hdr='<td><i class="'+icon+'"></i>'+hcat+'</td>';if(this.isMobile){tmp=hdr+tmp;}else{html+=hdr;}
data+=tmp;}}
html+='</tr>'+'</thead>'+'<tbody>'+'<tr>'+data+'</tr>'+'</tbody>'+'</table>';var tab=$('#search-result-tab');if(!count){tab.append('<tr><td colspan="4">Nothing :(</td></tr>');}else if(!this.isMobile){$('.scrollbar-inner').scrollbar();}};